# WIN_RATE_MAX_NO_SECTOR — профиль правил (максимизация win rate без секторных подтверждений)

Цель профиля: **максимально поднять win rate**, принимая, что:
- сделок станет меньше;
- средний профит на сделку может снизиться (больше “ранних фиксаций”);
- стратегия станет более “fail-closed” (лучше пропустить, чем войти сомнительно).

---

## 0) Термины (как читать правила)

- **Bar**: 1‑минутный бар.
- **Signal (Initiator)**: первичный алерт по аномалии `z_ER` (и сопутствующим фильтрам).
- **Pending**: сигнал в “watch window”, который **может** привести к входу, если выполнятся entry‑triggers.
- **Entry‑triggers**: условия, которые должны выполниться **после** сигнала (когда импульс “остыл” и снова начал продолжение).
- **Direction**: LONG если `z_ER > 0`, SHORT если `z_ER < 0` (все проверки direction‑aware).

---

## 1) Жёсткий гейтинг: когда вообще разрешено торговать

### 1.1. Качество рыночного режима (BTC‑фильтр)
**Запрет на вход** (пропускаем все pending/entries), если выполняется любое:
- BTC в собственной “аномалии” (по тем же правилам initiator на BTCUSDT) в последние **N минут**.
- Абсолютная 1‑мин волатильность BTC выше “режимного потолка” (любая твоя метрика, которой уже доверяешь).

Рекомендуемо: `N = 10–20 минут` (win‑rate bias).

### 1.2. Ликвидность/качество символа (анти‑шум)
**Запрет на вход**, если:
- нет достаточного объёма/ликвидности (любой твой критерий: min 1m volume, min trades, spread proxy и т.п.);
- символ известен “шипами”/неустойчивыми принтами (внутренний blacklist).

Win‑rate профили почти всегда выигрывают от blacklist’а.

### 1.3. Качество beta‑нейтрализации (если метрика доступна)
Если у тебя есть оценка качества (R²/корреляция/стабильность β), то:
- **Запрет на вход**, если качество ниже порога (например, `R² < 0.2` или корреляция к BTC “плохая”).
- **Запрет на вход**, если β “нелепая” (примерно: `|β| < 0.1` или `|β| > 3.0`).

Если таких метрик нет — этот пункт пропускается (но для win rate он очень полезен).

### 1.4. Cooldown по символу (у тебя уже есть — делаем строже для win rate)
- После закрытия позиции по символу: **cooldown на новые входы** в ту же сторону минимум **60 минут**.
- При смене направления допускается вход только после “grace window” (например, 15 минут) **и** полного выполнения строгих entry‑triggers.

---

## 2) Когда создаём pending (Signal правила)

### 2.1. Сигнал создаётся только при “полном” initiator‑пакете
Для win rate важно не плодить weak‑pending’и.

**Создаём pending только если одновременно:**
- `abs(z_ER) >= 3.0`
- `abs(z_VOL) >= 3.0`
- taker dominance на импульсе **строже**, чем обычно: `>= 0.65` в сторону сигнала

Если хочешь ещё поднять win rate (за счёт частоты):
- требовать, чтобы импульс был не “одной свечой” (например, `abs(z_ER)` держался ≥3.0 хотя бы 2 бара подряд).

### 2.2. Fail‑closed по данным
Если не хватает критичных данных для оценки entry‑triggers → **не входить** (pending может существовать, но entry запрещён, пока данные не появятся).

---

## 3) Watch window (TTL) и базовая логика pending

### 3.1. TTL короче (против “протухших” входов)
- **Максимальный watch window:** `6 минут` (вместо 10).

### 3.2. Минимальная задержка перед входом
- **Минимум 1 бар** после сигнала (чтобы не поймать случайное совпадение условий на первом же баре).

---

## 4) Entry‑triggers (строгий win‑rate пакет)

Вход разрешён **только** на первом баре, где выполнены ВСЕ условия ниже.

### 4.1. Z‑cooldown: “остыло, но не умерло”
- Требовать: `2.0 <= abs(z_ER) <= 2.7`
- И дополнительно: `abs(z_ER)` **не падает 2 бара подряд** (защита от “остыло и продолжило сыпаться”).

### 4.2. Pullback: есть откат от peak_since_signal, но без слома структуры
- Минимальный pullback от `peak_since_signal`:
  - `>= max(0.5%, 0.8 × ATR / price)` (если ATR доступен)
  - иначе: `>= 0.8%` (фиксированно, win‑rate bias)
- Защита от разворота: pullback **не должен быть слишком глубоким**:
  - `<= 2.2 × ATR / price` (если ATR доступен)
  - иначе: `<= 2.0%`

### 4.3. Order flow: доминирование + стабильность (строже)
- `taker_dominance >= 0.58` в сторону сигнала
- `taker_flow_stability <= 0.06` (макс изменение 6%)

### 4.4. Re‑expansion (обязательное подтверждение “движение возобновилось”)
После выполнения cooldown + pullback + flow **нельзя входить сразу**.
Нужно выполнить хотя бы **1 из 3** условий “ускорения”:

Для LONG (для SHORT зеркально):
1) **Price action:** `close текущего бара > high предыдущего бара`
2) **Микро‑импульс:** доходность текущего бара в сторону сигнала (bar return > 0 для long / < 0 для short)
3) **Flow acceleration:** taker dominance усиливается **2 бара подряд** (каждый бар выше предыдущего)

> Это ключевой win‑rate фильтр: убирает “остыло и умерло/развернулось”.

### 4.5. (Опционально, если есть API‑данные) — подтверждения, которые резко чистят входы
Если доступны OI/liquidations/funding — для win rate стоит требовать **минимум 1 подтверждение**:

- **OI‑подтверждение:** рост OI в сторону импульса (порог задаёшь сам: % или z‑метрика).
- **Liquidations‑подтверждение:** всплеск ликвидаций в контр‑стороне (типичный признак “выноса”).
- **Funding‑контекст:** funding не противоречит направлению или не экстремально против (избежать “ловли ножа” в перегретом funding).

Если этих данных нет — вход всё равно возможен, но пункты 4.1–4.4 остаются обязательными.

---

## 5) Invalidation pending (жёстко выкидываем плохие сетапы)

Pending немедленно invalidated, если выполняется любое:

### 5.1. Direction invalidation (у тебя уже есть — делаем приоритет №1)
- знак `z_ER` сменился на противоположный (direction reversal).

### 5.2. “Momentum died”
- `abs(z_ER) < 1.8` до входа.

### 5.3. “Flow died / flipped”
- taker dominance упал ниже `0.52` и держится **2 бара**.

### 5.4. “Структура сломана”
- pullback стал глубже “верхнего лимита” (см. 4.2).

### 5.5. TTL expiry
- прошло `> 6 минут` с момента сигнала → pending закрыть без входа.

---

## 6) Выходы (win‑rate bias)

Цель: чаще закрываться в плюс, меньше отдавать прибыль обратно, быстрее признавать ошибку.

### 6.1. Базовые ATR‑выходы
- `SL = 1.5 × ATR`
- `TP = 2.0 × ATR` (пониженный TP под win rate)

### 6.2. Trailing stop (раньше и плотнее)
- Активация трейла: после достижения **35%** пути к TP
- Дистанция трейла: `0.8 × ATR`

### 6.3. Exit по order flow reversal (если уже включено — делаем более чувствительным)
- Если включён exit_on_order_flow_reversal:
  - threshold сделать чуть строже, например **0.12** вместо 0.15 (быстрее уходим при развороте потока)

### 6.4. Time stop (против затяжного флэта, который часто заканчивается в минус)
- Если позиция не дошла до `+0.5 × ATR` за **T минут**, закрыть по рынку.
Рекомендуемо: `T = 20–30 минут`.

### 6.5. Частичная фиксация (самый простой буст win rate, если допускаешь)
- Закрыть **50%** позиции на `+1.0 × ATR`
- Остаток вести трейлом/TP
- После частичной фиксации: перевести SL в безубыток (или в `-0.2 × ATR` с учётом комиссий/спреда)

---

## 7) Итоговый “чеклист” входа (как должен выглядеть идеальный win‑rate сетап)

1) Нет BTC‑аномалии и нет режима “хаоса”
2) Символ ликвидный, не в blacklist
3) Initiator сильный: `z_ER>=3`, `z_VOL>=3`, taker dominance >=0.65 (aligned)
4) В течение 6 минут:
   - z_ER остыл в [2.0..2.7] и не продолжает падать 2 бара подряд
   - был pullback (min) и не слишком глубокий (max)
   - taker dominance >=0.58 и stability <=0.06
   - есть re‑expansion (price action / micro impulse / flow acceleration)
5) Открываем позицию на первом баре, где всё выполнено

---

## 8) Рекомендуемые значения параметров (в терминах конфигурации)

- `entry_trigger_max_wait_minutes: 6`
- `entry_trigger_min_wait_bars: 1`
- `entry_trigger_z_cooldown: 2.0` (и верхняя граница 2.7 как правило)
- `entry_trigger_pullback_pct: 0.8` (если без ATR‑адаптации)
- `entry_trigger_taker_stability: 0.06`
- `entry_trigger_min_taker_dominance: 0.58`

ATR/Trailing (win‑rate bias):
- `atr_stop_multiplier: 1.5`
- `atr_target_multiplier: 2.0`
- `trailing_stop_activation: 0.35`
- `trailing_stop_distance_atr: 0.8`

---

## 9) Что этот профиль гарантированно изменит в статистике

- **Win rate ↑**
- **Частота сделок ↓**
- **Средний RR ↓** (из-за более ранних TP / частичных фиксаций)
- **Доля “протухших входов” ↓** (TTL 6 минут + re‑expansion)
