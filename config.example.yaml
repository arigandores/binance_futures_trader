# Binance Anomaly Detector - Configuration
# Copy this file to config.yaml and customize for your setup

api:
  key: ""  # Optional - if empty, advanced features (OI, taker ratio) disabled
  secret: ""  # Required by Binance even for read-only endpoints

universe:
  benchmark_symbol: "BTCUSDT"
  # List of symbols to monitor for anomalies
  # Each symbol is analyzed independently against BTC benchmark
  symbols:
    - "ZECUSDT"
    - "DASHUSDT"
    - "XMRUSDT"
    - "UNIUSDT"
    - "AAVEUSDT"
    - "SUSHIUSDT"
    - "COMPUSDT"
    - "ETHUSDT"
    - "SOLUSDT"
    - "AVAXUSDT"
    - "ADAUSDT"

windows:
  bar_interval_sec: 60
  zscore_lookback_bars: 720  # 12h on 1m bars
  beta_lookback_bars: 240  # 4h (reduced from 24h to reduce noise)
  beta_aggregation_minutes: 5  # Aggregate 1m bars to 5m for beta calculation
  initiator_eval_window_bars: 15  # 15m
  confirm_window_bars: 60  # 1h

thresholds:
  excess_return_z_initiator: 3.0
  volume_z_initiator: 3.0
  taker_dominance_min: 0.65  # Taker buy share threshold
  liquidation_z_confirm: 2.0
  funding_abs_threshold: 0.0010  # 0.1% absolute threshold instead of quantile

alerts:
  cooldown_minutes_per_symbol: 60
  direction_swap_grace_minutes: 15  # Allows opposite direction sooner than cooldown
  telegram:
    enabled: false
    bot_token: ""
    chat_id: ""

storage:
  sqlite_path: "./data/market.db"
  wal_mode: true  # Write-Ahead Logging for better concurrency
  batch_write_interval_sec: 5  # Batch inserts every N seconds

position_management:
  enabled: true  # Enable virtual position tracking
  allow_multiple_positions: false  # Only one position per symbol at a time

  # Entry Triggers (Signal+Trigger separation) - FIXED ARCHITECTURE
  use_entry_triggers: true  # Enable pending signals queue (watch window)
  entry_trigger_max_wait_minutes: 10  # Max watch window (TTL) - NOT fixed delay!
  entry_trigger_min_wait_bars: 0  # Optional: min bars before allowing entry (0 = immediate if ready)
  entry_trigger_z_cooldown: 2.0  # Min z-score after cooling [2.0, 3.0]
  entry_trigger_pullback_pct: 0.5  # Required pullback % from peak_since_signal
  entry_trigger_taker_stability: 0.10  # Max taker flow change (stability check)
  entry_trigger_min_taker_dominance: 0.55  # Must-Fix #7: Min buy/sell dominance (0.55 = 55%)
  entry_trigger_require_data: true  # Must-Fix #4: Fail-closed if data missing (safer)

  # Dynamic Stops/Targets (IMPROVED)
  atr_period: 10  # Shorter period for crypto volatility (was 14)
  atr_stop_multiplier: 1.5  # Tighter stops (1.5x ATR, was 2.0x)
  atr_target_multiplier: 3.0  # Wider targets (3x ATR for 1:2 ratio)
  min_risk_reward_ratio: 2.0  # Minimum R:R ratio enforced
  use_atr_stops: true  # Use ATR for dynamic stop loss

  # Trailing Stop (NEW)
  use_trailing_stop: true  # Enable trailing stops
  trailing_stop_activation: 0.5  # Activate at 50% of TP
  trailing_stop_distance_atr: 1.0  # Trail at 1x ATR distance

  # Exit Conditions (RELAXED)
  z_score_exit_threshold: 0.5  # More lenient (was 1.0)
  max_hold_minutes: 120  # Allow more time (was 60)

  # Order Flow Reversal - KEEP CURRENT
  exit_on_order_flow_reversal: true  # Exit if taker buy/sell flow reverses sharply
  order_flow_reversal_threshold: 0.15  # 15% change in taker flow triggers exit

  # Opposite Signal Exit - KEEP CURRENT
  exit_on_opposite_signal: false  # Exit if strong opposite direction signal appears
  opposite_signal_threshold: 2.5  # Z-score threshold for opposite direction

  # Legacy Fixed Stops (FALLBACK - used if ATR unavailable)
  stop_loss_percent: 2.0
  take_profit_percent: 4.0  # Increased from 3.0 for better R:R

  # =====================================================================
  # Profile Selection
  # =====================================================================
  # Options: "DEFAULT", "WIN_RATE_MAX"
  # - DEFAULT: Balanced profile (current settings above)
  # - WIN_RATE_MAX: Win-rate optimization (higher quality, lower frequency)
  profile: "WIN_RATE_MAX"

  # =====================================================================
  # WIN_RATE_MAX Profile Configuration
  # =====================================================================
  # Win-rate optimization profile targeting higher quality entries with
  # stricter validation. Expect 30-50% fewer trades but significantly
  # higher win rate (target: 55-65% vs 35-45% for DEFAULT).
  #
  # When profile: "WIN_RATE_MAX", these settings override DEFAULT values.
  # When profile: "DEFAULT", this section is ignored.
  # =====================================================================
  win_rate_max_profile:

    # ------------------------------------------------------------------
    # Watch Window Configuration
    # Shorter TTL for faster invalidation of weak setups
    # ------------------------------------------------------------------
    entry_trigger_max_wait_minutes: 6  # Reduced from 10 (faster invalidation)
    entry_trigger_min_wait_bars: 1     # Require at least 1 bar confirmation

    # ------------------------------------------------------------------
    # Z-Score Cooldown Range
    # Both min AND max bounds for tighter control of entry timing
    # Entry only allowed when z-score cools INTO this range
    # ------------------------------------------------------------------
    entry_trigger_z_cooldown_min: 2.0  # Minimum z-score after cooling
    entry_trigger_z_cooldown_max: 2.7  # Maximum z-score (reject if still overheated)

    # ------------------------------------------------------------------
    # Pullback Validation (Dual Method)
    # Validates price structure using both fixed % AND ATR-based bounds
    # Rejects if pullback too small (no structure) or too large (breakdown)
    # ------------------------------------------------------------------
    # Fixed percentage bounds
    entry_trigger_pullback_min_pct: 0.8       # Min pullback % (structure formed)
    entry_trigger_pullback_max_pct: 2.0       # Max pullback % (structure intact)
    # ATR-based bounds (adapts to volatility)
    entry_trigger_pullback_min_atr: 0.5       # Min pullback in ATR units
    entry_trigger_pullback_max_atr: 2.2       # Max pullback in ATR units

    # ------------------------------------------------------------------
    # Taker Flow Validation
    # Stricter thresholds for higher quality directional bias
    # ------------------------------------------------------------------
    entry_trigger_taker_stability: 0.06           # Max flow change 6% (was 10%)
    entry_trigger_min_taker_dominance: 0.58       # Min dominance 58% (was 55%)

    # ------------------------------------------------------------------
    # Re-Expansion Confirmation (NEW)
    # Ensures momentum is resuming before entry, not just cooling off
    # At least ONE of the enabled methods must confirm
    # ------------------------------------------------------------------
    require_re_expansion: true                    # Enable re-expansion gate
    # Method 1: Price action - close breaks above previous bar high (long)
    re_expansion_price_action: true
    # Method 2: Micro impulse - bar return in expected direction
    re_expansion_micro_impulse: true
    # Method 3: Flow acceleration - taker dominance increasing
    re_expansion_flow_acceleration: true

    # ------------------------------------------------------------------
    # Enhanced Invalidation Rules
    # Stricter rules to cut bad setups early and preserve capital
    # ------------------------------------------------------------------
    # Z-score invalidation: kill pending if z drops below threshold
    invalidate_z_er_min: 1.8                      # Min z-score to stay valid
    # Taker dominance invalidation: kill pending if dominance too weak
    invalidate_taker_dominance_min: 0.52          # Min dominance to stay valid
    invalidate_taker_dominance_bars: 2            # Consecutive bars below to invalidate

    # ------------------------------------------------------------------
    # Exit Parameters (Win-Rate Biased)
    # Tighter stops, lower targets, earlier profit taking
    # ------------------------------------------------------------------
    atr_stop_multiplier: 1.5                      # Stop at 1.5x ATR (same as DEFAULT)
    atr_target_multiplier: 2.0                    # Target at 2.0x ATR (was 3.0x)
    trailing_stop_activation: 0.35                # Activate at 35% of TP (was 50%)
    trailing_stop_distance_atr: 0.8               # Trail at 0.8x ATR (was 1.0x)
    order_flow_reversal_threshold: 0.12           # Reversal at 12% change (was 15%)

    # ------------------------------------------------------------------
    # Partial Profit Taking (NEW)
    # Lock in gains early to improve realized win rate
    # ------------------------------------------------------------------
    use_partial_profit: true                      # Enable partial profit taking
    partial_profit_percent: 0.5                   # Close 50% of position
    partial_profit_target_atr: 1.0                # Take partial at +1.0x ATR
    partial_profit_move_sl_breakeven: true        # Move SL to breakeven after partial

    # ------------------------------------------------------------------
    # Time-Based Exit (NEW)
    # Cut stagnant positions that are not performing
    # ------------------------------------------------------------------
    time_exit_enabled: true                       # Enable time-based exit
    time_exit_minutes: 25                         # Max hold time without sufficient profit
    time_exit_min_pnl_atr_mult: 0.5               # Min profit to continue (+0.5x ATR)

    # ------------------------------------------------------------------
    # Market Regime Filters (NEW)
    # Avoid trading during unfavorable market conditions
    # ------------------------------------------------------------------
    # BTC Anomaly Filter: Block entries during BTC chaos
    btc_anomaly_filter: true                      # Enable BTC anomaly detection
    btc_anomaly_lookback_minutes: 10              # Lookback window for BTC anomaly

    # Symbol Quality Filter: Block low-quality or blacklisted symbols
    symbol_quality_filter: true                   # Enable symbol quality checks
    symbol_blacklist: []                          # Blacklist symbols (e.g., ["DOGEUSDT", "SHIBUSDT"])
    min_volume_usd: 100000.0                      # Min 1-minute volume in USDT
    min_trades_per_bar: 50                        # Min trades per 1-minute bar

    # Beta Quality Filter: Block symbols with unreliable beta estimates
    beta_quality_filter: true                     # Enable beta quality checks
    beta_min_abs: 0.1                             # Min |beta| (must have some correlation)
    beta_max_abs: 3.0                             # Max |beta| (reject outliers)
    beta_min_r_squared: 0.2                       # Min R-squared (future: not yet implemented)

  # =====================================================================
  # Profile Comparison Summary
  # =====================================================================
  # | Parameter                    | DEFAULT | WIN_RATE_MAX | Impact       |
  # |------------------------------|---------|--------------|--------------|
  # | max_wait_minutes             | 10      | 6            | Faster TTL   |
  # | min_wait_bars                | 0       | 1            | Min delay    |
  # | z_cooldown range             | 2.0+    | [2.0, 2.7]   | Tighter band |
  # | pullback validation          | min 0.5%| [0.8%, 2.0%] | Both bounds  |
  # | taker_stability              | 0.10    | 0.06         | Stricter     |
  # | taker_dominance              | 0.55    | 0.58         | Stricter     |
  # | re-expansion confirmation    | No      | Yes          | Quality gate |
  # | enhanced invalidation        | No      | Yes          | Cut losers   |
  # | atr_target_multiplier        | 3.0     | 2.0          | Lower target |
  # | trailing_stop_activation     | 0.50    | 0.35         | Earlier      |
  # | partial_profit_taking        | No      | Yes          | Lock gains   |
  # | time_exit                    | No      | Yes (25m)    | Cut stagnant |
  # | market_regime_filters        | No      | Yes          | Avoid chaos  |
  # |------------------------------|---------|--------------|--------------|
  # | Expected Win Rate            | 35-45%  | 55-65%       | +20% target  |
  # | Expected Trade Frequency     | 100%    | 50-70%       | -30-50%      |
  # =====================================================================

# ===========================================================================
# HYBRID STRATEGY CONFIGURATION (NEW)
# ===========================================================================
# The hybrid strategy dynamically selects between three trading modes based on
# signal strength (z-score magnitude). This solves the core problem of trying
# to trade mean-reversion patterns as momentum.
#
# Signal Classification:
#   - EXTREME_SPIKE (z >= 5.0): Mean-Reversion mode - FADE the move
#   - STRONG_SIGNAL (3.0-5.0): Conditional Momentum - need confirmation
#   - EARLY_SIGNAL (1.5-3.0): Early Momentum - wait for continuation
#
# Key Innovation: For extreme moves (z >= 5σ), trade AGAINST the anomaly
# (mean-reversion) because statistically extreme moves revert. For moderate
# moves, follow the momentum but require confirmation first.
# ===========================================================================

hybrid_strategy:
  enabled: false  # Master switch - set to true to enable hybrid strategy

  # Signal Classification Thresholds
  extreme_spike_threshold: 5.0    # z >= 5.0 = EXTREME_SPIKE (mean-reversion)
  strong_signal_min: 3.0          # z >= 3.0 = STRONG_SIGNAL (conditional momentum)
  early_signal_min: 1.5           # z >= 1.5 = EARLY_SIGNAL (wait for continuation)

  # =========================================================================
  # EXTREME_SPIKE Mode: Mean-Reversion (Fade the Move)
  # =========================================================================
  # For extreme z-scores (>= 5σ), statistically price will revert to mean.
  # Trade AGAINST the direction of the spike.
  # Example: z = +7.0 (extreme up move) → SHORT (fade the overbought spike)
  #
  # Entry: Wait for reversal signs (z dropping, volume fading, price confirming)
  # Exit: Quick scalps with tight targets (1x ATR TP, 1.2x ATR SL)
  mean_reversion:
    # Entry Triggers - wait for reversal confirmation
    reversal_z_drop_pct: 0.20           # Z must drop 20% from signal for entry
    min_bars_before_entry: 2            # Minimum 2 bars before entry allowed
    max_bars_before_expiry: 8           # TTL: max 8 bars to find entry
    require_price_confirmation: true    # Price must move in trade_direction
    require_volume_fade: true           # Volume must be declining

    # Invalidation Conditions
    invalidate_on_z_growth: true        # Invalidate if z continues growing
    z_growth_invalidate_threshold: 1.10 # If z grows 10% more, invalidate
    max_volume_growth_bars: 3           # Invalidate if volume grows N bars straight

    # Exit Parameters - quick scalps
    atr_target_multiplier: 1.0          # Quick TP: 1x ATR
    atr_stop_multiplier: 1.2            # Slightly wider stop: 1.2x ATR
    max_hold_minutes: 20                # Short holds for mean-reversion
    z_score_exit_threshold: 1.5         # Exit when z normalizes
    use_trailing_stop: false            # No trailing for quick scalps
    use_z_exit: true                    # Use z-score exit

  # =========================================================================
  # STRONG_SIGNAL Mode: Conditional Momentum
  # =========================================================================
  # For z-scores 3.0-5.0, could be start of big move OR reversal point.
  # Require additional confirmation before entering.
  #
  # Entry: Need no divergence, volume maintained, strong taker, stable z
  # Mode Switch: If momentum fails, switch to mean-reversion instead
  conditional_momentum:
    # Confirmation Requirements - ALL must be met
    min_taker_dominance: 0.70           # 70% buyers for LONG, 30% for SHORT
    min_volume_retention: 0.90          # Volume must not drop more than 10%
    max_z_variance_pct: 0.25            # Z variance must be < 25% of signal_z
    require_no_divergence: true         # Price and z must move together
    confirmation_bars: 3                # Need 3 bars for stability check
    max_wait_bars: 10                   # TTL: max 10 bars

    # Mode Switch Conditions (switch to mean-reversion if momentum fails)
    enable_mode_switch: true            # Allow switching to MR mode
    mode_switch_z_drop_pct: 0.30        # If z drops 30%, switch to MR
    mode_switch_taker_reversal: 0.50    # If taker crosses 50%, switch
    mode_switch_price_reversal: true    # If price reverses past signal, switch

    # Exit Parameters - balanced
    atr_target_multiplier: 2.0          # Standard TP: 2x ATR
    atr_stop_multiplier: 1.5            # Standard SL: 1.5x ATR
    max_hold_minutes: 45                # Medium holds
    z_score_exit_threshold: 0.8         # Exit when momentum weakens
    use_trailing_stop: true             # Enable trailing
    trailing_stop_activation_atr: 1.0   # Activate at +1 ATR
    trailing_stop_distance_atr: 0.8     # Trail at 0.8 ATR
    use_z_exit: true                    # Use z-score exit

  # =========================================================================
  # EARLY_SIGNAL Mode: Wait for Continuation
  # =========================================================================
  # For z-scores 1.5-3.0, anomaly just starting. Wait for confirmation
  # that the move is BUILDING, not fading.
  #
  # Entry: Wait 3-5 bars, need z growth, price follow-through, sustained volume
  # Potential: Catch beginning of big moves for larger profits
  early_momentum:
    # Continuation Criteria - must see momentum building
    min_z_growth_pct: 0.30              # Z must grow 30% from signal
    min_price_follow_through_pct: 0.15  # Price must move 0.15% in direction
    volume_must_sustain: true           # Volume must not decline
    min_taker_persistence: 0.55         # Min taker over last 3 bars (55% for LONG)

    # Timing
    min_wait_bars: 3                    # Must wait at least 3 bars
    max_wait_bars: 5                    # TTL: 5 bars

    # Invalidation
    z_decline_invalidate_pct: 0.20      # If z drops 20%, invalidate (momentum died)

    # Exit Parameters - long holds for big moves
    atr_target_multiplier: 3.0          # Wide target: 3x ATR
    atr_stop_multiplier: 1.5            # Standard stop: 1.5x ATR
    max_hold_minutes: 90                # Long holds
    use_trailing_stop: true             # Enable trailing
    trailing_stop_activation_atr: 1.5   # Activate later at +1.5 ATR
    trailing_stop_distance_atr: 1.0     # Wider trail: 1 ATR
    use_partial_profit: true            # Take partial at 1.5 ATR
    partial_profit_target_atr: 1.5      # Partial target
    partial_profit_percent: 0.50        # Close 50%
    use_z_exit: false                   # Don't exit on z - let it run

  # =========================================================================
  # Common Settings (all modes)
  # =========================================================================
  common:
    # Volume filter for all signals
    min_volume_z_for_signal: 1.5        # Minimum vol_z for any signal

    # Taker thresholds (used in classification)
    taker_bullish_threshold: 0.55       # >55% = bullish flow
    taker_bearish_threshold: 0.45       # <45% = bearish flow
    taker_extreme_bullish: 0.70         # >70% = strong bullish
    taker_extreme_bearish: 0.30         # <30% = strong bearish

    # Position limits
    max_positions_total: 5              # Maximum open positions
    max_positions_per_mode: 2           # Maximum positions per mode

  # =========================================================================
  # Expected Performance by Mode
  # =========================================================================
  # | Mode                | Entry Rate | Win Rate | Avg P/L  | Hold Time |
  # |---------------------|------------|----------|----------|-----------|
  # | MEAN_REVERSION      | 40-60%     | 55-65%   | +0.3-0.5%| 5-20 min  |
  # | CONDITIONAL_MOMENTUM| 15-25%     | 45-55%   | +0.6-1.0%| 15-45 min |
  # | EARLY_MOMENTUM      | 20-35%     | 40-50%   | +1.0-2.0%| 30-90 min |
  # =========================================================================
  #
  # Note: Mean-reversion has higher entry rate because reversal signs are easier
  # to detect than continuation confirmation. Win rate is higher due to
  # statistical advantage of extreme move reversion.

runtime:
  log_level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  rest_poll_sec: 60
  ws_reconnect_backoff_sec: [1, 2, 5, 10, 30]
  clock_skew_tolerance_sec: 2
